import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../network/dio_client.dart';
import '../network/openai_api_client.dart';
import '../../features/settings/data/settings_repository.dart';
import '../../features/settings/domain/api_config.dart';

/// 网络 Providers
/// API 客户端、连接配置相关

// ============ API 配置 ============

/// 活跃 API 配置 Provider
final activeApiConfigProvider = FutureProvider.autoDispose<ApiConfig?>((
  ref,
) async {
  final settingsRepo = ref.watch(settingsRepositoryProvider);
  return await settingsRepo.getActiveApiConfig();
});

// ============ Dio 客户端 ============

/// Dio 客户端 Provider
final dioClientProvider = Provider<DioClient>((ref) {
  final apiConfig = ref.watch(activeApiConfigProvider).value;
  final baseUrl = apiConfig?.baseUrl ?? '';
  final apiKey = apiConfig?.apiKey ?? '';
  return DioClient(
    baseUrl: baseUrl,
    apiKey: apiKey,
  );
});

// ============ OpenAI API 客户端 ============

/// OpenAI API 客户端 Provider
final openAIApiClientProvider = Provider<OpenAIApiClient>((ref) {
  final apiConfig = ref.watch(activeApiConfigProvider).value;
  final dioClient = ref.watch(dioClientProvider);
  return OpenAIApiClient(dioClient, apiConfig?.provider);
});
